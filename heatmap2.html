<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Game stats 2</title>
</head>
<script src="js/urgent.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
<style>
	body {
		background-color: #f3f3f3;
	}
	button {
		touch-action: manipulation;
	}
	#heatmap {
		position: relative;
		/*top: 0;
		left: 0;
		/*width: 100%;*/
		/*height: 100%;*/
		/*background: #a9a9a9*/
	}

	.render {
		width:98%;
		margin-left: auto; !important;
		margin-right: auto; !important;
	}

	.table-sm>:not(caption)>*>* {
		padding: .0rem 0.3rem;
	}
	button {
		margin-bottom: 0.2em;
		margin-right: 0.2em;
	}
	.progbar{
		margin-bottom: 0.2em;
		margin-inline: 1px;
	}

	.stats-inline {
		display: inline-flex;
		width: 100%;
	}

	#host_shots_prog {
		background-color: #ff7c7c; !important;
	}

	#host_shots_on_goal_prog {
		background-color: #ff4040; !important;
	}
	#host_goals_prog {
		background-color: #b02424; !important;
	}

	#guest_shots_prog {
		background-color: #759aff; !important;
	}

	#guest_shots_on_goal_prog {
		background-color: #2964ee; !important;
	}
	#guest_goals_prog {
		background-color: #0d3db7; !important;
	}
	/*#hosts {
		background-color: #ffafaf;
		color: #2f2f2f;
	}
	#guests {
		background-color: #7c8dff;
	}*/
	.types {
		width: 30%;
		background-color: #f3f3f3;
		color: black;
		text-align: left;
	}
	.team{
		height: 1em; !important;
	}



</style>
<body>

<div class="container">
	<div class="row">
		<div class="col-md-6 offset-md-3">
			<div id="main_id" class="">
				<canvas class="mt-1 render position-absolute top-10 start-50 translate-middle-x" id='my-canvas' ></canvas>
				<canvas class="mt-1 render position-absolute top-10 start-50 translate-middle-x" id='heatmap' ></canvas>
				<canvas class="mt-1 render position-absolute top-10 start-50 translate-middle-x" id='goals' ></canvas>
				<!-- обработка клика происходит в конце main.js -->
			</div>
		</div>
	</div>

</div>




<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-sm modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<small class="modal-title fs-6" id="exampleModalLabel">Бросок [<span id="coordinate_x"></span>.<span id="coordinate_y"></span>]</small>
			</div>
			<div class="modal-body">
				<!-- FORM CONTROL -->
				<form>
					<div>
						<div class="btn-group btn-group-sm"  style="width: 100%" role="group" aria-label="Basic example">

							<input type="radio" class="btn-check" name="shots" id="isShot" autocomplete="off" onchange="checkType()">
							<label class="btn btn-outline-primary" for="isShot">Бросок</label>

							<input type="radio" class="btn-check" name="shots" id="isTarget" autocomplete="off" onchange="checkType()">
							<label class="btn btn-outline-primary" for="isTarget">Створ</label>

							<input type="radio" class="btn-check btn-sm" name="shots" id="isGoal" autocomplete="off" onchange="checkType()">
							<label class="btn btn-outline-primary" for="isGoal">Гол</label>


						</div>
					</div>
					<hr>
					<div>
						<div class="btn-group btn-group-sm"  style="width: 100%" role="group" aria-label="Basic example">
							<input type="radio" class="btn-check btn-sm" name="teams" id="team1" autocomplete="off" onchange="checkType();transfer_team_data('team_id', this.getAttribute('team_id'))">
							<label id="team1_label"  class="btn btn-outline-danger" for="team1"></label>

							<input type="radio" class="btn-check" name="teams" id="team2" autocomplete="off" onchange="checkType();transfer_team_data('team_id', this.getAttribute('team_id'))">
							<label id="team2_label" class="btn btn-outline-primary" for="team2"></label>
						</div>
						<hr>
						<div id="players">
						</div>
					</div>
				</form>
				<!-- FORM CONTROL -->

			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetModal()">Отмена</button>
				<button id="sendData" type="button" class="btn btn-primary" onclick="closeModal()">Сохранить</button>
			</div>
			<span id="team_id_data"></span>
		</div>
	</div>
</div>
<div class="modal-backdrop fade show" id="backdrop" style="display: none;"></div>
<script id="getUrlParameters">
	function getURLValues() {
		const search = window.location.search.replace(/^\?/, '').replace(/\+/g, ' ');
		const values = {};
		if (search.length) {
			let part, parts = search.split('&');

			let i = 0, iLen = parts.length;
			for (; i<iLen; i++ ) {
				part = parts[i].split('=');
				values[part[0]] = window.decodeURIComponent(part[1]);
			}
		}
		return values
	}
</script>

<script id="svg_rendering">
	const canvas = document.querySelector('#my-canvas');
	const context = canvas.getContext('2d');
	const image = new Image();
	const ih = 1300
	const iw = 1700
	image.src = 'https://www.tagban.ru/plus/stats/img/rink_halved.svg';
	image.onload = function() {
		let cvs = document.getElementById("my-canvas")
		cvs.width = iw
		cvs.height = ih
		context.drawImage(image, 0, 0); // drawImage(image, x-start, y-start, width, height)
		const heatmap = document.querySelector('#heatmap');
		const hmp = heatmap.getContext('2d')
		hmp.width = iw
		hmp.height = ih
		const gls = heatmap.getContext('2d')
		gls.width = iw
		gls.height = ih
		document.getElementById("heatmap").width = iw
		document.getElementById("heatmap").height = ih
		document.getElementById("goals").width = iw
		document.getElementById("goals").height = ih
	};
	image.onerror = function() {
		context.fillStyle = 'red';
		context.font = '16px Arial';
		context.fillText('ERROR!', 1, 3);
	};

	////////////////////////////////////////

</script>
<script>
	function openModal(x,y) {
		checkType()
		document.getElementById("backdrop").style.display = "block"
		document.getElementById("exampleModal").style.display = "block"
		document.getElementById("exampleModal").classList.add("show")
		document.getElementById("coordinate_x").innerHTML = x
		document.getElementById("coordinate_y").innerHTML = y
	}
	const shots = []
	function getCoordinates(log) {
		let outputCoordinates = []
		for (let i = 0; i < log.length; i++) {outputCoordinates.push([log[i][0], log[i][1]])}
		return outputCoordinates
	}

	function closeModal() {
		let point_x = document.getElementById("coordinate_x").innerHTML
		let point_y = document.getElementById("coordinate_y").innerHTML
		drawPoint(point_x, point_y)
		document.getElementById("backdrop").style.display = "none"
		document.getElementById("exampleModal").style.display = "none"
		document.getElementById("exampleModal").classList.remove("show")
		document.getElementById('team1').checked = false
		document.getElementById('team2').checked = false
		console.log(heatData)
		document.getElementById('isGoal').checked = false
		document.getElementById('isShot').checked = false
		document.getElementById('isTarget').checked = false
	}

	function resetModal() {
		document.getElementById("backdrop").style.display = "none"
		document.getElementById("exampleModal").style.display = "none"
		document.getElementById("exampleModal").classList.remove("show")
		document.getElementById('team1').checked = false
		document.getElementById('team2').checked = false
		document.getElementById('isGoal').checked = false
		document.getElementById('isShot').checked = false
		document.getElementById('isTarget').checked = false
	}
</script>
<script id="check_types">
	function checkType() {
		if ((document.getElementById('isGoal').checked === false && document.getElementById('isShot').checked === false && document.getElementById('isTarget').checked === false) ||
				(document.getElementById('team1').checked === false && document.getElementById('team2').checked === false)) {
			document.getElementById("sendData").disabled = true
		} else {
			document.getElementById("sendData").disabled = false
		}
	}
</script>
<script id="sendCoordinates">
	function transfer_team_data(attribute, data) {
		document.getElementById("team_id_data").setAttribute(attribute, data)
	}

	function sendShot(game, player, x, y, isGoal, team_id, isTarget) {
		let sog
		if (isGoal && document.getElementById('isTarget').checked === false){
			sog = true
		} else if (isGoal === false && document.getElementById('isTarget').checked === true){
			sog = true
		}
		let params = JSON.stringify({
			"items":
					[
						{
						"game_id": document.getElementById("team_id_data").getAttribute("game_id"),
						"shot_x": parseInt(x),
						"shot_y": parseInt(y),
						"is_goal": isGoal,
						"team_id": document.getElementById("team_id_data").getAttribute("team_id"),
						"player_id": document.getElementById("team_id_data").getAttribute("player_id"),
						"is_target": sog
						}
					]
		})
		const options = {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				Authorization: 'Token 11609376-ff57-401e-88a4-53f4c0904fdb'
			},
			body: params
		};
		fetch('https://x125.ru/api/stats/inputshots', options)
				.then(response => response.json())
				.then(response => console.log(response))
				.catch(err => console.error(err));
	}
</script>

<script id="API">
	function APISendRequest(funcName, body) {
		const options = {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				Authorization: 'Token 11609376-ff57-401e-88a4-53f4c0904fd8'
			},
			body: body
		};
		return fetch('https://x125.ru/api/stats/'+funcName, options)
				.catch(err => console.error(err))
				.then(response => response.json())
				.then(response => {
					//console.log(response)
					return response;
					})
	}

</script>
<script>
	const script = document.createElement('script');
	script.src='js/json.js'+ '?t=' + Date.now();
	document.body.appendChild(script);
	script.addEventListener('load', function() {
		const script3 = document.createElement('script');
		script3.src='./js/heatmap.js'+ '?t=' + Date.now();
		document.body.appendChild(script3);
		console.log('script loaded')
		const script2 = document.createElement('script');
		script2.src='js/main.js'+ '?t=' + Date.now();
		document.body.appendChild(script2);
	});
</script>
</body>
</html>
